# =============================================================================
# Platform God - Docker Compose Configuration
# =============================================================================
# Development and local deployment configuration for Platform God
# =============================================================================

services:
  # --------------------------------------------------------------------------
  # Platform God API Server
  # --------------------------------------------------------------------------
  platform-god:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        PYTHON_VERSION: "3.14"
        PGOD_VERSION: "0.1.0"
    image: platform-god:local
    container_name: platform-god-api

    # Command to run the API server
    command: ["serve", "--port", "8000", "--host", "0.0.0.0"]

    # Environment variables
    environment:
      # Application settings
      - PGOD_LOG_LEVEL=${PGOD_LOG_LEVEL:-INFO}
      - PGOD_VAR_DIR=/app/var

      # LLM Provider (choose one)
      - PG_LLM_PROVIDER=${PG_LLM_PROVIDER:-anthropic}
      - PG_LLM_MODEL=${PG_LLM_MODEL:-claude-3-5-sonnet-20241022}

      # API Keys (set in .env file)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - PG_LLM_BASE_URL=${PG_LLM_BASE_URL:-}

    # Port mappings
    ports:
      - "${PGOD_PORT:-8000}:8000"

    # Volume mounts for persistent state
    volumes:
      # Persistent state storage
      - pgod_var:/app/var

      # Mount repositories to analyze (read-only)
      # - /path/to/local/repo:/repo:ro

      # For development: mount source code for hot reload
      # - ./src:/app/src:ro
      # - ./prompts:/app/prompts:ro

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health/ping').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Network
    networks:
      - platform-god-net

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --------------------------------------------------------------------------
  # Optional: Worker service for background job processing
  # Uncomment to enable
  # --------------------------------------------------------------------------
  # platform-god-worker:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   image: platform-god:local
  #   container_name: platform-god-worker
  #
  #   # Worker command (you would need to implement this)
  #   command: ["worker", "--poll-interval", "60"]
  #
  #   environment:
  #     - PGOD_LOG_LEVEL=${PGOD_LOG_LEVEL:-INFO}
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #
  #   volumes:
  #     - pgod_var:/app/var
  #
  #   restart: unless-stopped
  #   networks:
  #     - platform-god-net


# =============================================================================
# Named Volumes
# =============================================================================
volumes:
  pgod_var:
    name: pgod_var_data
    driver: local


# =============================================================================
# Networks
# =============================================================================
networks:
  platform-god-net:
    name: platform-god-network
    driver: bridge


# =============================================================================
# Usage Examples:
# =============================================================================
#
# Start the API server:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f
#
# Run CLI commands:
#   docker-compose run --rm platform-god agents list
#   docker-compose run --rm platform-god inspect /repo
#
# Execute a chain:
#   docker-compose run --rm \
#     -v /path/to/repo:/repo:ro \
#     platform-god run discovery /repo --dry-run
#
# Stop services:
#   docker-compose down
#
# Rebuild after changes:
#   docker-compose build --no-cache
#   docker-compose up -d
#
# Access the API:
#   curl http://localhost:8000/health
#   curl http://localhost:8000/api/v1/agents
#
# OpenAPI docs:
#   http://localhost:8000/docs
#
 =============================================================================
