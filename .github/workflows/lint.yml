# Platform God - Lint Workflow
#
# Runs code quality and style checks on every push and pull request.
# Uses ruff for fast linting and formatting checks.

name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ruff:
    name: "Ruff linting"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: |
          ruff check . \
            --output-format=github \
            --show-fixes \
            --exclude=".venv,venv,_sources,.pytest_cache,__pycache__"

      - name: Run ruff format check
        run: |
          ruff format --check .

  mypy:
    name: "Type checking with mypy"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install mypy types-pyyaml
          pip install -e .

      - name: Run mypy
        continue-on-error: true
        run: |
          mypy src/platform_god \
            --ignore-missing-imports \
            --no-strict-optional \
            --warn-redundant-casts \
            --warn-unused-ignores \
            --warn-return-any \
            --pretty

  bandit:
    name: "Security linting with bandit"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit
        continue-on-error: true
        run: |
          bandit -r src/platform_god \
            -f json \
            -o bandit-report.json \
            || true

      - name: Display bandit results
        if: always()
        run: |
          if [ -f bandit-report.json ]; then
            cat bandit-report.json | python -m json.tool || cat bandit-report.json
          fi

      - name: Upload bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 7

  yaml-lint:
    name: "YAML linting"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint -f github configs/ .github/workflows/ || true

  config-validation:
    name: "Configuration validation"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pyyaml jsonschema

      - name: Validate configuration files
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path

          configs = [
              'configs/pg.default.yaml',
              'configs/pg.dev.yaml',
              'configs/pg.staging.yaml',
              'configs/pg.prod.yaml'
          ]

          for config_path in configs:
              path = Path(config_path)
              if path.exists():
                  try:
                      data = yaml.safe_load(path.read_text())
                      print(f'✓ {config_path}: Valid YAML, version={data.get(\"version\", \"unknown\")}')
                  except Exception as e:
                      print(f'✗ {config_path}: {e}')
                      sys.exit(1)
              else:
                  print(f'⚠ {config_path}: File not found (skipping)')
          "

  license-check:
    name: "License header check"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check license headers
        run: |
          python -c \"
          import sys
          from pathlib import Path

          missing = []
          for py_file in Path('src/platform_god').rglob('*.py'):
              content = py_file.read_text()
              if len(content) > 100 and 'Copyright' not in content and 'license' not in content.lower():
                  missing.append(str(py_file))

          if missing:
              print('Files missing license headers:')
              for f in missing:
                  print(f'  {f}')
              sys.exit(1)
          else:
              print('All source files have license information.')
          \"
        continue-on-error: true

  lint-summary:
    name: "Lint summary"
    runs-on: ubuntu-latest
    needs: [ruff, mypy, bandit, yaml-lint, config-validation]
    if: always()

    steps:
      - name: Check lint results
        run: |
          results=[\"${{ needs.ruff.result }}\",\"${{ needs.mypy.result }}\",\"${{ needs.bandit.result }}\",\"${{ needs.yaml-lint.result }}\",\"${{ needs.config-validation.result }}\"]
          failed=[\"failure\",\"cancelled\",\"skipped\"]
          for r in \"${{ needs.ruff.result }}\" \"${{ needs.mypy.result }}\" \"${{ needs.bandit.result }}\" \"${{ needs.yaml-lint.result }}\" \"${{ needs.config-validation.result }}\"; do
            if [[ \"\\$failed\" == *\"\\$r\"* ]]; then
              echo \"::error::One or more lint jobs failed. Check the logs above.\"
              exit 1
            fi
          done
          echo \"::notice::All lint checks passed!\"
        shell: bash
