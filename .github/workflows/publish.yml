# Platform God - Publish Workflow
#
# Publishes the package to PyPI on release.
# Triggers on GitHub releases with version tags.

name: Publish to PyPI

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write  # Required for trusted publishing

jobs:
  validate:
    name: "Validate release"
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_prerelease: ${{ steps.check_prerelease.outputs.is_prerelease }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION#v}"

      - name: Check if pre-release
        id: check_prerelease
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [[ "$VERSION" =~ (a|b|rc|alpha|beta|dev) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "::notice::Pre-release version detected, will publish to TestPyPI"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "::notice::Stable version detected, will publish to PyPI"
          fi

      - name: Validate version format
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "::error::Expected format: X.Y.Z or X.Y.ZrcN"
            exit 1
          fi

      - name: Verify version in pyproject.toml
        run: |
          EXPECTED="${{ steps.get_version.outputs.version }}"
          ACTUAL=$(grep '^version = ' pyproject.toml | sed 's/version = "\([^"]*\)"/\1/')
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "::error::Version mismatch: tag says $EXPECTED but pyproject.toml has $ACTUAL"
            exit 1
          fi
          echo "Version $ACTUAL matches pyproject.toml"

  build:
    name: "Build distribution packages"
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling twine

      - name: Build distribution packages
        run: python -m build

      - name: Check distribution packages
        run: twine check dist/*

      - name: List built packages
        run: ls -lh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/
          retention-days: 7

  publish-testpypi:
    name: "Publish to TestPyPI"
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.is_prerelease == 'true'

    environment:
      name: testpypi
      url: https://test.pypi.org/p/platform-god

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install twine
        run: pip install twine

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          twine upload \
            --repository testpypi \
            --verbose \
            dist/*

      - name: Verify TestPyPI upload
        run: |
          sleep 10  # Wait for index to update
          pip install --index-url https://test.pypi.org/simple/ \
            --extra-index-url https://pypi.org/simple \
            platform-god==${{ needs.validate.outputs.version }}
          platform-god --version || pgod --version

  publish-pypi:
    name: "Publish to PyPI"
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.is_prerelease == 'false'

    environment:
      name: pypi
      url: https://pypi.org/p/platform-god

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install twine
        run: pip install twine

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload \
            --verbose \
            dist/*

      - name: Verify PyPI upload
        run: |
          sleep 10  # Wait for index to update
          pip install platform-god==${{ needs.validate.outputs.version }}
          platform-god --version || pgod --version

  github-release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: [validate, publish-testpypi, publish-pypi]
    if: |
      always() &&
      (needs.publish-testpypi.result == 'success' || needs.publish-pypi.result == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          NOTES="## Platform God v${VERSION}

          ### Installation
          \`\`\`bash
          pip install platform-god==${VERSION}
          \`\`\`

          ### What's Changed
          See the changelog for details.

          ### Distribution
          - wheel: https://pypi.org/project/platform-god/${VERSION}/
          "
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create/update GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            dist/*.whl
            dist/*.tar.gz
          fail_on_unmatched_files: true
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: "Post-release tasks"
    runs-on: ubuntu-latest
    needs: [validate, publish-testpypi, publish-pypi]
    if: needs.publish-pypi.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install build hatchling
          pip install -e .

      - name: Bump version for next release
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          IFS='.' read -ra PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH.dev0"

          # Update pyproject.toml
          sed -i 's/version = ".*"/version = "'$NEW_VERSION'"/' pyproject.toml

          echo "Bumped version to: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        id: bump_version

      - name: Create post-release PR
        if: github.ref == 'refs/heads/main'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Bump version to ${{ steps.bump_version.outputs.new_version }}"
          body: |
            Automated version bump after release ${{ needs.validate.outputs.version }}

            - Updated version to `${{ steps.bump_version.outputs.new_version }}`
          branch: chore/bump-version
          commit-message: "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            chore
            version-bump
